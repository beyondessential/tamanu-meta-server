<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg" />
    <link rel="stylesheet" href="/static/bulma/bulma.min.css">
    <link rel="stylesheet" href="/static/private/main.css">
    <title>Tamanu Password Generator</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .logo-section img {
            height: 60px;
        }

        .password-display {
            font-family: monospace;
            font-size: 1.1em;
            word-break: break-all;
        }

        .field-horizontal {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .field-horizontal .field {
            flex: 1;
            margin-bottom: 0;
        }

        .verification-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
        }

        .verification-result.valid {
            background-color: #f0fdf4;
            color: #22c55e;
            border: 1px solid #86efac;
        }

        .verification-result.invalid {
            background-color: #fef2f2;
            color: #ef4444;
            border: 1px solid #fca5a5;
        }

        .verification-result.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .logo-section {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .field-horizontal {
                flex-direction: column;
                align-items: stretch;
            }

            .field-horizontal .field {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <section class="hero is-light">
        <div class="hero-body">
            <div class="container">
                <div class="logo-section">
                    <img src="/static/images/tamanu_logo.svg" alt="Tamanu Logo" />
                    <div>
                        <h1 class="title">Password Generator</h1>
                        <p class="subtitle">Generate secure passwords for Tamanu systems</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <!-- Password Generation Section -->
            <div class="box mb-5">
                <h2 class="title is-5 mb-4">Generate Password</h2>

                <div class="field">
                    <label class="label">Product</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="productSelect">
                                <option value="bta">Tamanu</option>
                                <option value="btu">Tupaia</option>
                                <option value="bsn">SENAITE</option>
                                <option value="bes">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Length</label>
                    <div class="control">
                        <input class="input" type="number" id="passwordLength" value="20" min="15" max="64">
                    </div>
                </div>

                <div class="field">
                    <label class="label">Options</label>
                    <div class="control">
                        <label class="checkbox mb-3">
                            <input type="checkbox" id="useSymbols" checked>
                            Symbols
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" id="useChecksum" checked>
                            Checksum
                        </label>
                    </div>
                </div>

                <div class="field is-grouped mb-4">
                    <p class="control">
                        <button class="button is-primary" id="generateBtn">
                            Generate Password
                        </button>
                    </p>
                </div>

                <div class="field">
                    <label class="label">Generated Password</label>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input password-display" type="text" id="generatedPassword" readonly autocomplete="off">
                        </div>
                        <div class="control">
                            <button class="button" id="copyBtn" title="Copy to clipboard">
                                ðŸ“‹ Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Verification Section -->
            <div class="box">
                <h2 class="title is-5 mb-4">Verify Password</h2>

                <div class="field">
                    <label class="label">Enter Password to Verify</label>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input password-display" type="text" id="passwordToVerify" placeholder="Enter password with checksum to verify" autocomplete="off">
                        </div>
                        <div class="control">
                            <button class="button is-info" id="verifyBtn">
                                âœ“ Verify
                            </button>
                        </div>
                    </div>
                </div>

                <div id="verificationResult" class="verification-result hidden"></div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('generateBtn');
            const copyBtn = document.getElementById('copyBtn');
            const productSelect = document.getElementById('productSelect');
            const passwordLength = document.getElementById('passwordLength');
            const useSymbols = document.getElementById('useSymbols');
            const useChecksum = document.getElementById('useChecksum');
            const generatedPassword = document.getElementById('generatedPassword');
            const passwordToVerify = document.getElementById('passwordToVerify');
            const verifyBtn = document.getElementById('verifyBtn');
            const verificationResult = document.getElementById('verificationResult');

            // Calculate checksum for a string using a simple CRC-like algorithm
            function calculateChecksum(str, charset) {
                let crc = 0;
                for (let i = 0; i < str.length; i++) {
                    crc = ((crc << 5) - crc + str.charCodeAt(i)) & 0xFFFF;
                }

                const firstChar = charset.charAt(crc % charset.length);
                const secondChar = charset.charAt(Math.floor(crc / charset.length) % charset.length);

                return firstChar + secondChar;
            }

            // Generate password function
            function generatePassword() {
                const prefix = productSelect.value + '_';
                const desiredLength = parseInt(passwordLength.value, 10);
                const includeSymbols = useSymbols.checked;
                const includeChecksum = useChecksum.checked;

                const checksumLength = includeChecksum ? 3 : 0;
                const randomPartLength = desiredLength - prefix.length - checksumLength;

                const lowercase = 'abcdefghijklmnopqrstuvwxyz';
                const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const numbers = '0123456789';
                const symbols = '@$%&';

                let charset = lowercase + uppercase + numbers;
                if (includeSymbols) {
                    charset += symbols;
                }

                let randomString = '';
                const randomValues = new Uint8Array(randomPartLength);
                window.crypto.getRandomValues(randomValues);

                for (let i = 0; i < randomPartLength; i++) {
                    randomString += charset.charAt(randomValues[i] % charset.length);
                }

                if (!/[0-9]/.test(randomString)) {
                    return generatePassword();
                }

                if (includeSymbols && !symbols.split('').some(char => randomString.includes(char))) {
                    return generatePassword();
                }

                const basePassword = prefix + randomString;

                if (includeChecksum) {
                    const checksum = calculateChecksum(basePassword, charset);
                    return basePassword + '.' + checksum;
                }

                return basePassword;
            }

            // Verify password function
            function verifyPassword(password) {
                const parts = password.split('.');
                if (parts.length !== 2) {
                    return {
                        valid: false,
                        message: 'Invalid format: Password should contain a base part and a checksum separated by a dot (.)'
                    };
                }

                const basePassword = parts[0];
                const providedChecksum = parts[1];

                if (providedChecksum.length !== 2) {
                    return {
                        valid: false,
                        message: 'Invalid checksum length: Checksum should be 2 characters'
                    };
                }

                const lowercase = 'abcdefghijklmnopqrstuvwxyz';
                const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const numbers = '0123456789';
                const symbols = '@$%&';

                let charset = lowercase + uppercase + numbers;
                if (/[@$%&]/.test(password)) {
                    charset += symbols;
                }

                const expectedChecksum = calculateChecksum(basePassword, charset);

                if (providedChecksum === expectedChecksum) {
                    return {
                        valid: true,
                        message: 'Password checksum is valid.'
                    };
                } else {
                    return {
                        valid: false,
                        message: `Invalid checksum: Expected ${expectedChecksum}, got ${providedChecksum}`
                    };
                }
            }

            // Generate password on page load
            generatedPassword.value = generatePassword();

            // Generate password on button click
            generateBtn.addEventListener('click', function() {
                generatedPassword.value = generatePassword();
            });

            // Copy to clipboard functionality
            copyBtn.addEventListener('click', function() {
                generatedPassword.select();
                document.execCommand('copy');

                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ“ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            });

            // Verify password on button click
            verifyBtn.addEventListener('click', function() {
                const password = passwordToVerify.value.trim();
                if (!password) {
                    verificationResult.textContent = 'Please enter a password to verify.';
                    verificationResult.classList.remove('hidden');
                    verificationResult.classList.remove('valid');
                    verificationResult.classList.add('invalid');
                    return;
                }

                const result = verifyPassword(password);
                verificationResult.textContent = result.message;
                verificationResult.classList.remove('hidden');
                if (result.valid) {
                    verificationResult.classList.remove('invalid');
                    verificationResult.classList.add('valid');
                } else {
                    verificationResult.classList.remove('valid');
                    verificationResult.classList.add('invalid');
                }
            });

            // Verify on Enter key
            passwordToVerify.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    verifyBtn.click();
                }
            });
        });
    </script>
</body>
</html>
